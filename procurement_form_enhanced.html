<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced ART Model - Open Requirements Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 10px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px; /* Slightly wider for more content */
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #0056b3;
            margin-block-start: 0;
            margin-block-end: 0;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .form-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-section input[type="checkbox"],
        .form-section input[type="radio"] {
            margin-right: 10px;
            vertical-align: top;
            margin-top: 2px;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: #000;
            color: #fff;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
            border-radius: 0 0 4px 4px;
        }
        .skip-link:focus {
            top: 0;
        }
        input:focus,
        textarea:focus,
        button:focus {
            outline: 2px solid #005fcc;
            outline-offset: 2px;
        }
        fieldset {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            background-color: #f9f9f9;
        }
        legend {
            font-weight: bold;
            color: #0056b3;
            padding: 0 10px;
            font-size: 1.1em;
        }
        .form-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .form-group label {
            font-weight: normal;
            line-height: 1.4;
            margin-bottom: 0;
        }
        .form-group input[type="checkbox"],
        .form-group input[type="radio"] {
            flex-shrink: 0;
            margin-right: 10px;
            margin-top: 2px;
        }
        .form-section p {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #666;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            font-weight: normal; /* Override bold for individual checkbox/radio labels */
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            margin-top: 30px;
            padding: 15px;
            background-color: #e2eafc;
            border: 1px solid #c2d9f7;
            white-space: pre-wrap; /* Preserves formatting of the generated text */
            font-family: 'Courier New', monospace; /* Monospace for code-like output */
            font-size: 0.9em;
            color: #000;
        }
        #output h2 {
            color: #0056b3;
        }
        #output pre {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dcdcdc;
            overflow-x: auto; /* For horizontal scrolling if content is wide */
        }
        .error-message {
            color: red;
            font-size: 0.8em;
            margin-top: 5px;
            display: none; /* Hidden by default */
        }
        input:invalid:not(:placeholder-shown) {
            border-color: red;
        }
        /* Procurement Officer Guidance Section */
        .procurement-guidance {
            background-color: #e7f3ff;
            border-left: 4px solid #2563eb;
            max-width: 800px; /* Adjust this value as desired */
            margin: 15px auto; /* Reduced top/bottom margins */
            padding: 15px; /* Added padding inside the guidance box */
        }
        .procurement-guidance h3 {
            margin-top: 0;
            margin-bottom: 1px; /* Reduced bottom margin */
            margin-block-start: 0; /* Override browser default */
            margin-block-end: 0; /* Override browser default */
            color: #1e40af;
            font-size: 1.2em;
        }
        .procurement-guidance h4 {
            color: #1e40af;
            margin-top: 1px; /* Reduced top margin */
            margin-bottom: 1px; /* Reduced bottom margin */
            margin-block-start: 0; /* Override browser default */
            margin-block-end: 0; /* Override browser default */
        }
        .procurement-guidance p {
            line-height: 1.4;
            margin-top: 0;
            margin-bottom: 1px; /* Reduced bottom margin */
        }
        .procurement-guidance ul {
            padding-left: 20px;
            margin-top: 0;
            margin-bottom: 1px; /* Reduced bottom margin */
        }
        .procurement-guidance li {
            line-height: 1.3;
            margin-bottom: 1px; /* Reduced spacing between list items */
        }
        .procurement-guidance .important-note {
            margin-bottom: 0;
            font-style: italic;
            color: #1e40af;
            font-weight: bold;
        }
        fieldset[aria-labelledby="websiteQuestion"] {
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap to the next line if needed */
            align-items: center; /* Vertically aligns items in the center */
        }
        /* Adjust margin for spacing if necessary */
        fieldset[aria-labelledby="websiteQuestion"] .form-check-inline {
            margin-right: 15px; /* Adds some space between Yes/No and input */
        }
        fieldset[aria-labelledby="websiteQuestion"] #websiteInputContainer {
            flex-grow: 1; /* Allows the input container to take up available space */
            margin-left: 10px; /* Space between No and the input field */
            min-width: 200px; /* Ensure input field has a reasonable minimum width */
        }
        /* To ensure the question text itself doesn't interfere with the flex layout */
        fieldset[aria-labelledby="websiteQuestion"] .question-text {
            flex-basis: 100%; /* Makes the question take full width */
            margin-bottom: 1px; /* Adds space below the question */
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <div class="container">
        <h1>Enhanced ICT Accessibility Requirements Generator</h1>
        <p>Generate clear, actionable accessibility requirements based on the <a href="https://github.com/CivicActions/open-practice/blob/main/open-requirements-library/accessibility.md" target="_blank">Open Requirements Library</a> and best practices for government procurement.</p>

        <main id="main-content">

        <form id="procurementForm">
            <fieldset>
                <legend>Project Information</legend>
                <label for="projectName">Project Name: <span style="color:red;" aria-label="required">*</span></label>
                <input type="text" id="projectName" name="projectName" placeholder="Enter project name" required style="width: 100%; padding: 8px; box-sizing: border-box;" aria-describedby="projectNameError">
                <div class="error-message" id="projectNameError" role="alert">Project Name is required.</div>
            </fieldset>

            <div class="form-section">
                <h2>Solicitation Phase</h2>
                <p>Select one of the options below:</p>
                <div class="form-group">
                    <input type="radio" id="phasePlanning" name="solicitationPhase" value="projectPlanning" checked>
                    <label for="phasePlanning">Project Planning<br><em>I want to identify the applicable Section 508 standards I need to address during project planning</em></label>
                </div>
                <div class="form-group">
                    <input type="radio" id="phaseMarketResearch" name="solicitationPhase" value="marketResearch">
                    <label for="phaseMarketResearch">Market Research<br><em>I want to obtain product documentation and/or capability statements to determine the availability of accessible products and services using a Request for information (RFI).</em></label>
                </div>
                <div class="form-group">
                    <input type="radio" id="phaseDevelopment" name="solicitationPhase" value="solicitationDevelopment">
                    <label for="phaseDevelopment">Solicitation Development<br><em>I want to obtain Section 508 requirements to include in my statement of work</em></label>
                </div>
            </div>

            <div class="form-section">
                <h2>ICT Type</h2>
                <p>What type of ICT do you have? Please select all that apply.</p>
                <div class="form-group">
                    <input type="checkbox" id="ictProduct" name="ictType" value="products">
                    <label for="ictProduct">ICT Products (example: web and non-web-based electronic content, software, licenses, hardware)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="ictService" name="ictType" value="services">
                    <label for="ictService">ICT Services (example: cloud services; contractor services to develop, modify, install, configure, integrate, maintain, or host ICT)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="ictNone" name="ictType" value="none" checked>
                    <label for="ictNone">None of the above</label>
                </div>
            </div>

            <div class="form-section">
                <h2>Exemptions & Exceptions</h2>
                <div class="form-group">
                    <input type="radio" id="exemptionNone" name="exemption" value="none" checked>
                    <label for="exemptionNone">No exemptions apply</label>
                </div>
                <div class="form-group">
                    <input type="radio" id="exemptionDontKnow" name="exemption" value="dontKnow">
                    <label for="exemptionDontKnow">I don’t have one / I don’t know</label>
                </div>
                <div class="form-group">
                    <input type="radio" id="nationalSecurity" name="exemption" value="nationalSecurity">
                    <label for="nationalSecurity">National Security Exemption<br><em>Check if your system qualifies as a national security system</em></label>
                </div>
                <div class="form-group">
                    <input type="radio" id="ictFunctions" name="exemption" value="ictFunctions">
                    <label for="ictFunctions">ICT Functions Located in Maintenance and Monitoring Spaces Exception</label>
                </div>
                <div class="form-group">
                    <input type="radio" id="fundamentalAlteration" name="exemption" value="fundamentalAlteration">
                    <label for="fundamentalAlteration">Fundamental Alteration Exception</label>
                </div>
                <div class="form-group">
                    <input type="radio" id="federalContracts" name="exemption" value="federalContracts">
                    <label for="federalContracts">Federal Contracts Exception<br><em>This is not a common exception applied to procurements</em></label>
                </div>
                <div class="form-group">
                    <input type="radio" id="undueBurden" name="exemption" value="undueBurden">
                    <label for="undueBurden">Undue Burden Exception</label>
                </div>
            </div>

            <div class="form-section">
                <h2>Electronic Content</h2>
                <p>Does your solicitation include electronic content?</p>
                <p>I.e. Electronic forms, surveys, web, multimedia, document templates, etc.</p>
                <div class="form-group">
                    <input type="radio" id="eContentYes" name="eContent" value="yes" checked>
                    <label for="eContentYes">Yes</label>
                </div>
                <div class="form-group">
                    <input type="radio" id="eContentNo" name="eContent" value="no">
                    <label for="eContentNo">No</label>
                </div>

                <fieldset class="form-group" aria-labelledby="websiteQuestion">
                    <legend id="websiteQuestion" class="question-text">Will this electronic content be made available through a website?</legend>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="websiteRadio" id="websiteYes" value="yes">
                        <label class="form-check-label" for="websiteYes">Yes</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="websiteRadio" id="websiteNo" value="no">
                        <label class="form-check-label" for="websiteNo">No</label>
                    </div>
                    <div id="websiteInputContainer" style="display: none;">
                        <label for="websiteURL" class="sr-only">Website URL</label>
                        <input type="url" class="form-control mt-2" id="websiteURL" placeholder="Enter website URL">
                    </div>
                </fieldset>
            </div>

            <div class="form-section">
                <h2>Software</h2>
                <p>Does the software meet any of the following criteria?</p>
                <div class="form-group">
                    <input type="checkbox" id="softwareNoUI" name="softwareCriteria" value="noUI">
                    <label for="softwareNoUI">Does not have an end-user interface (i.e. user screens)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="softwareAT" name="softwareCriteria" value="assistiveTech">
                    <label for="softwareAT">Principal function is assistive technology</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="softwareDontKnow" name="softwareCriteria" value="dontKnow">
                    <label for="softwareDontKnow">I don’t know</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="softwareNone" name="softwareCriteria" value="none" **checked**>
                    <label for="softwareNone">None of the above</label>
                </div>

                <div id="softwarePurchaseQuestion">
                    <p>Are you purchasing any software items, deliverables, or licenses?</p>
                    <p><em>Programs, procedures, rules, and related data and documentation that direct the use and operation of ICT and instruct it to perform a given task or function. Software includes, but is not limited to, applications, non-Web software, and platform software.</em></p>
                    <p>(Check all that apply)</p>
                    <div class="form-group">
                        <input type="checkbox" id="appWebDesktopServer" name="softwarePurchaseType" value="webDesktopServer">
                        <label for="appWebDesktopServer">Web, desktop, server, mobile client applications (e.g., Time and attendance software, DHS productivity applications, Web forms/applications, Call Center Support applications, Workflow applications, Content management systems, Learning management systems)</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="appAuthoringTools" name="softwarePurchaseType" value="authoringTools">
                        <label for="appAuthoringTools">Software authoring tools and platforms (e.g., Microsoft Office, Adobe Acrobat Professional, Adobe InDesign, PDF Generators and Converters, Graphing and Charting Programs)</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="appInfrastructure" name="softwarePurchaseType" value="infrastructure">
                        <label for="appInfrastructure">Software Infrastructure (e.g., Operating Systems, Browsers, Systems/network administration software, Remote access software, User authentication software, Virtual meeting tools)</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="appOther" name="softwarePurchaseType" value="other">
                        <label for="appOther">Other</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="appNone" name="softwarePurchaseType" value="none" checked>
                        <label for="appNone">None of the above</label>
                    </div>
                </div>

                <div id="cloudServiceQuestion" style="display: none;">
                    <p>Will the software be provided through any of the following types of cloud services agreements? (Check all that apply)</p>
                    <div class="form-group">
                        <input type="checkbox" id="cloudSaaS" name="cloudServiceType" value="SaaS">
                        <label for="cloudSaaS">Software as a Service (SaaS)</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="cloudPaaS" name="cloudServiceType" value="PaaS">
                        <label for="cloudPaaS">Platform as a Service (PaaS)</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="cloudOther" name="cloudServiceType" value="other">
                        <label for="cloudOther">Other Cloud Services arrangement</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="cloudDontKnow" name="cloudServiceType" value="dontKnow">
                        <label for="cloudDontKnow">I don't know</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="cloudNone" name="cloudServiceType" value="none" checked>
                        <label for="cloudNone">None of the above</label>
                    </div>
                </div>

                <div id="webBrowserSoftwareQuestion" style="display: none;">
                    <p>Will this software be accessible through a web browser?</p>
                    <div class="form-group">
                        <input type="radio" id="softwareWebBrowserYes" name="softwareWebBrowser" value="yes">
                        <label for="softwareWebBrowserYes">Yes</label>
                    </div>
                    <div class="form-group">
                        <input type="radio" id="softwareWebBrowserNo" name="softwareWebBrowser" value="no">
                        <label for="softwareWebBrowserNo">No</label>
                    </div>
                </div>

                <div id="authoringToolQuestion" style="display: none;">
                    <p>Will this software be used to create electronic content (e.g. an authoring tool that is used to create HTML pages, reports, surveys, charts, dashboards, etc.)?</p>
                    <div class="form-group">
                        <input type="radio" id="authoringToolYes" name="authoringTool" value="yes">
                        <label for="authoringToolYes">Yes</label>
                    </div>
                    <div class="form-group">
                        <input type="radio" id="authoringToolNo" name="authoringTool" value="no">
                        <label for="authoringToolNo">No</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2>Hardware</h2>
                <p>Are you purchasing any hardware items, deliverables, or licenses?</p>
                <p>Where components of ICT are hardware and transmit information or have a user interface, such components shall conform to the requirements in Chapter 4. Hardware is considered a tangible device, equipment, or physical component of ICT, such as telephones, computers, multifunction copy machines, and keyboards.</p>
                <p>Please select all that apply.</p>
                <div class="form-group">
                    <input type="checkbox" id="hardwareComputers" name="hardwareType" value="computers">
                    <label for="hardwareComputers">Computers and laptops</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareTablet" name="hardwareType" value="tablet">
                    <label for="hardwareTablet">Tablet</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwarePrinters" name="hardwareType" value="printers">
                    <label for="hardwarePrinters">Printers, Scanners, or Copiers</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareMultiFunction" name="hardwareType" value="multiFunction">
                    <label for="hardwareMultiFunction">Multi-function office machines</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwarePeripheral" name="hardwareType" value="peripheral">
                    <label for="hardwarePeripheral">Peripheral Equipment (i.e. keyboard, mouse)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareKiosks" name="hardwareType" value="kiosks">
                    <label for="hardwareKiosks">Information kiosks and transaction machines</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareMobile" name="hardwareType" value="mobile">
                    <label for="hardwareMobile">Mobile phones</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareVideoConf" name="hardwareType" value="videoConf">
                    <label for="hardwareVideoConf">Video Teleconference Equipment</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareVideoDisplay" name="hardwareType" value="videoDisplay">
                    <label for="hardwareVideoDisplay">Video Displays or Monitors</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareServers" name="hardwareType" value="servers">
                    <label for="hardwareServers">Servers</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareOther" name="hardwareType" value="other">
                    <label for="hardwareOther">Other</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="hardwareNone" name="hardwareType" value="none" checked>
                    <label for="hardwareNone">None of the above</label>
                </div>

                <div class="form-group" id="serverInstallationQuestion" style="display: none;">
                    <p>Will the server require physical installation or is provided through an Infrastructure as a Service (IaaS) agreement?</p>
                    <input type="radio" id="serverInstallationYes" name="serverInstallation" value="yes">
                    <label for="serverInstallationYes">Yes</label>
                    <input type="radio" id="serverInstallationNo" name="serverInstallation" value="no">
                    <label for="serverInstallationNo">No</label>
                    <input type="radio" id="serverInstallationDontKnow" name="serverInstallation" value="dontKnow">
                    <label for="serverInstallationDontKnow">I don't know</label>
                </div>
            </div>

            <div class="form-section">
                <h2>Support Documentation & Services</h2>
                <p>What ICT support documentation or service are your procuring?</p>
                <div class="form-group">
                    <input type="checkbox" id="supportSelfService" name="supportType" value="selfService">
                    <label for="supportSelfService">Automated self-service & Technical support</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="supportHelpDesk" name="supportType" value="helpDesk">
                    <label for="supportHelpDesk">Help Desk or Call service center</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="supportProductDoc" name="supportType" value="productDoc">
                    <label for="supportProductDoc">Product documentation</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="supportTraining" name="supportType" value="training">
                    <label for="supportTraining">Training Service</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="supportNone" name="supportType" value="none" checked>
                    <label for="supportNone">None of the above</label>
                </div>
            </div>

            <div class="form-section" style="text-align: center; padding: 20px;">
                <button type="submit" style="margin-right: 10px;">Generate Section 508 Requirements</button>
                <button type="button" id="saveDataBtn" style="margin-right: 10px; background-color: #28a745;">Save Form Data</button>
                <button type="button" id="loadDataBtn" style="background-color: #6c757d;">Load Form Data</button>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>
        </form>

        <div id="output" role="region" aria-live="polite" aria-label="Generated requirements">
            <p style="text-align: center; color: #666;">Fill out the form and click "Generate Section 508 Requirements" to see the output.</p>
        </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('procurementForm');
            const outputDiv = document.getElementById('output');
            const projectNameInput = document.getElementById('projectName');
            const projectNameError = document.getElementById('projectNameError');

            // Get references to conditionally displayed questions
            const webContentQuestion = document.getElementById('webContentQuestion');
            const eContentRadios = document.querySelectorAll('input[name="eContent"]');

            const cloudServiceQuestion = document.getElementById('cloudServiceQuestion');
            const webBrowserSoftwareQuestion = document.getElementById('webBrowserSoftwareQuestion');
            const authoringToolQuestion = document.getElementById('authoringToolQuestion');
            const softwarePurchaseTypes = document.querySelectorAll('input[name="softwarePurchaseType"]');

            const serverInstallationQuestion = document.getElementById('serverInstallationQuestion');
            const hardwareTypeCheckboxes = document.querySelectorAll('input[name="hardwareType"]');

            // --- Function to parse URL parameters and populate form ---
            function populateFormFromURL() {
                const urlParams = new URLSearchParams(window.location.search);

                // Project Name
                if (urlParams.has('projectName')) {
                    projectNameInput.value = urlParams.get('projectName');
                }

                // Radio Buttons (e.g., solicitationPhase, exemption, eContent, websiteRadio, softwareWebBrowser, authoringTool, serverInstallation)
                const radioGroups = ['solicitationPhase', 'exemption', 'eContent', 'websiteRadio', 'softwareWebBrowser', 'authoringTool', 'serverInstallation'];
                radioGroups.forEach(groupName => {
                    if (urlParams.has(groupName)) {
                        const value = urlParams.get(groupName);
                        const radio = document.querySelector(`input[name="${groupName}"][value="${value}"]`);
                        if (radio) {
                            radio.checked = true;
                            // DO NOT trigger change event during initial population to avoid loops
                        }
                    } else {
                        // If parameter is missing, ensure default is selected or nothing
                        const defaultRadio = document.querySelector(`input[name="${groupName}"][checked]`);
                        if (!defaultRadio) { // If no default `checked` attribute, ensure all are unchecked
                             document.querySelectorAll(`input[name="${groupName}"]`).forEach(radio => radio.checked = false);
                        }
                    }
                });

                // Checkboxes (e.g., ictType, softwareCriteria, softwarePurchaseType, cloudServiceType, hardwareType, supportType)
                const checkboxGroups = ['ictType', 'softwareCriteria', 'softwarePurchaseType', 'cloudServiceType', 'hardwareType', 'supportType'];
                checkboxGroups.forEach(groupName => {
                    // First, uncheck all in the group to avoid conflicts with default `checked` attributes
                    document.querySelectorAll(`input[name="${groupName}"]`).forEach(checkbox => {
                        checkbox.checked = false;
                    });

                    if (urlParams.has(groupName)) {
                        const values = urlParams.getAll(groupName); // Use getAll for multiple values
                        values.forEach(value => {
                            const checkbox = document.querySelector(`input[name="${groupName}"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                // DO NOT trigger change event during initial population to avoid loops
                            }
                        });
                    } else {
                        // If parameter is missing, ensure the 'none' option (if it exists) is checked by default
                        const noneCheckbox = document.querySelector(`input[name="${groupName}"][value="none"]`);
                        if (noneCheckbox) {
                            noneCheckbox.checked = true;
                            // DO NOT trigger change event during initial population to avoid loops
                        }
                    }
                });

                // Specific text/URL inputs
                if (urlParams.has('websiteURL')) {
                    const websiteURLInput = document.getElementById('websiteURL');
                    if (websiteURLInput) {
                        websiteURLInput.value = urlParams.get('websiteURL');
                        document.getElementById('websiteInputContainer').style.display = 'block'; // Ensure container is visible
                    }
                }
            }

            // --- Save and Load Form Data Functions ---
            const saveDataBtn = document.getElementById('saveDataBtn');
            const loadDataBtn = document.getElementById('loadDataBtn');
            const fileInput = document.getElementById('fileInput');

            // Function to collect all form data
            function collectFormData() {
                // Helper function to map solicitation phase values
                function getSolicitationPhaseValue() {
                    const selected = document.querySelector('input[name="solicitationPhase"]:checked')?.value;
                    const mapping = {
                        'projectPlanning': 'red', // Use official ART color values
                        'marketResearch': 'blue', 
                        'solicitationDevelopment': 'green'
                    };
                    return mapping[selected] || selected;
                }

                const timestamp = Date.now().toString();
                const formData = {
                    name: projectNameInput.value.trim(),
                    langKeyWords: {
                        "sol-type": {
                            "sol-type": getSolicitationPhaseValue() || ""
                        },
                        "ict-group": {},
                        "ict-mark-research-group": {},
                        "exemptions-group": {},
                        "excep-nbr": "",
                        "elec-group": {
                            "elec-group": document.querySelector('input[name="eContent"]:checked')?.value ? 
                                `elec-${document.querySelector('input[name="eContent"]:checked').value}` : ""
                        },
                        "elec-web-group": {
                            "elec-web-group": document.querySelector('input[name="websiteRadio"]:checked')?.value ? 
                                `content-website-${document.querySelector('input[name="websiteRadio"]:checked').value}` : ""
                        },
                        "content-group": {
                            "websiteURL": document.getElementById('websiteURL')?.value || ""
                        },
                        "agency-comm": {},
                        "soft-criteria-group": {},
                        "software-group": {},
                        "soft-serv-group": {},
                        "soft-web-group": {
                            "soft-web-group": document.querySelector('input[name="softwareWebBrowser"]:checked')?.value ? 
                                `soft-web-${document.querySelector('input[name="softwareWebBrowser"]:checked').value}` : ""
                        },
                        "soft-create-group": {
                            "soft-create-group": document.querySelector('input[name="authoringTool"]:checked')?.value ? 
                                `soft-create-${document.querySelector('input[name="authoringTool"]:checked').value}` : ""
                        },
                        "hardware-group": {},
                        "server-iaas-group": {},
                        "support-doc-group": {}
                    },
                    timeStamp: timestamp
                };

                // Handle ICT Type checkboxes
                document.querySelectorAll('input[name="ictType"]').forEach(checkbox => {
                    let value = checkbox.value;
                    if (value === 'products') value = 'prod';
                    else if (value === 'services') value = 'serv';
                    
                    const key = `it-${value}-${timestamp}-0`;
                    formData.langKeyWords["ict-group"][key] = checkbox.checked ? true : null;
                });

                // Handle Exemptions radio buttons - convert to proper values
                const selectedExemption = document.querySelector('input[name="exemption"]:checked');
                if (selectedExemption) {
                    let value = selectedExemption.value;
                    // Map form values to JSON values
                    const exemptionMapping = {
                        'none': 'none',
                        'dontKnow': 'idk',
                        'nationalSecurity': 'nat-sec',
                        'ictFunctions': 'mon-spa',
                        'fundamentalAlteration': 'alter',
                        'federalContracts': 'fed-con',
                        'undueBurden': 'und-bur'
                    };
                    value = exemptionMapping[value] || value;
                    
                    const key = `excep-${value}-${timestamp}-0`;
                    formData.langKeyWords["exemptions-group"][key] = true;
                }

                // Handle Software Criteria checkboxes
                document.querySelectorAll('input[name="softwareCriteria"]').forEach(checkbox => {
                    let value = checkbox.value;
                    // Map form values to JSON values
                    const softwareMapping = {
                        'noUI': 'no-user-interface',
                        'assistiveTech': 'assistive',
                        'dontKnow': 'idk',
                        'none': 'none'
                    };
                    value = softwareMapping[value] || value;
                    
                    const key = `soft-${value}-${timestamp}-0`;
                    formData.langKeyWords["soft-criteria-group"][key] = checkbox.checked ? true : null;
                });

                // Handle Software Purchase Type checkboxes
                document.querySelectorAll('input[name="softwarePurchaseType"]').forEach(checkbox => {
                    let value = checkbox.value;
                    if (value === 'webDesktopServer') value = 'web-app';
                    else if (value === 'authoringTools') value = 'auth-tool';
                    else if (value === 'infrastructure') value = 'infra';
                    
                    const key = `software-${value}-${timestamp}-0`;
                    formData.langKeyWords["software-group"][key] = checkbox.checked ? true : null;
                });

                // Handle Cloud Service Type checkboxes
                document.querySelectorAll('input[name="cloudServiceType"]').forEach(checkbox => {
                    let value = checkbox.value;
                    if (value === 'SaaS') value = 'saas';
                    else if (value === 'PaaS') value = 'paas';
                    else if (value === 'dontKnow') value = 'idk';
                    
                    const key = `soft-serv-${value}-${timestamp}-0`;
                    formData.langKeyWords["soft-serv-group"][key] = checkbox.checked ? true : null;
                });

                // Handle Hardware Type checkboxes
                document.querySelectorAll('input[name="hardwareType"]').forEach(checkbox => {
                    let value = checkbox.value;
                    // Map form values to JSON values
                    const hardwareMapping = {
                        'computers': 'computer',
                        'tablet': 'tablet',
                        'printers': 'printer',
                        'multiFunction': 'multi-func',
                        'peripheral': 'peripheral',
                        'kiosks': 'kiosk',
                        'mobile': 'mobile',
                        'videoConf': 'video-telecon',
                        'videoDisplay': 'video-monitor',
                        'servers': 'server',
                        'other': 'other',
                        'none': 'none'
                    };
                    value = hardwareMapping[value] || value;
                    
                    const key = `hardware-${value}-${timestamp}-0`;
                    formData.langKeyWords["hardware-group"][key] = checkbox.checked ? true : null;
                });

                // Handle Support Type checkboxes
                document.querySelectorAll('input[name="supportType"]').forEach(checkbox => {
                    let value = checkbox.value;
                    if (value === 'selfService') value = 'tech';
                    else if (value === 'helpDesk') value = 'call';
                    else if (value === 'productDoc') value = 'doc';
                    else if (value === 'training') value = 'train';
                    
                    const key = `support-${value}-${timestamp}-0`;
                    formData.langKeyWords["support-doc-group"][key] = checkbox.checked ? true : null;
                });

                return formData;
            }

            // Function to populate form from loaded data
            function populateFormFromData(data) {
                // Clear all form fields first to avoid conflicts
                document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                
                // Set project name
                if (data.name) {
                    projectNameInput.value = data.name;
                }

                // Set solicitation phase - handle both old and new formats
                if (data.langKeyWords["sol-type"] && data.langKeyWords["sol-type"]["sol-type"]) {
                    const solPhase = data.langKeyWords["sol-type"]["sol-type"];
                    // Reverse mapping for solicitation phase
                    const solPhaseMapping = {
                        'proj-plan': 'projectPlanning',
                        'mark-research': 'marketResearch',
                        'solic-dev': 'solicitationDevelopment',
                        'red': 'projectPlanning', // Handle legacy "red" value
                        'blue': 'marketResearch', // Handle official ART "blue" value
                        'green': 'solicitationDevelopment' // Handle official ART "green" value
                    };
                    const mappedValue = solPhaseMapping[solPhase] || solPhase;
                    const solRadio = document.querySelector(`input[name="solicitationPhase"][value="${mappedValue}"]`);
                    if (solRadio) solRadio.checked = true;
                }

                // Set electronic content
                if (data.langKeyWords["elec-group"] && data.langKeyWords["elec-group"]["elec-group"]) {
                    const elecValue = data.langKeyWords["elec-group"]["elec-group"].replace('elec-', '');
                    const elecRadio = document.querySelector(`input[name="eContent"][value="${elecValue}"]`);
                    if (elecRadio) elecRadio.checked = true;
                }

                // Set website content
                if (data.langKeyWords["elec-web-group"] && data.langKeyWords["elec-web-group"]["elec-web-group"]) {
                    const webValue = data.langKeyWords["elec-web-group"]["elec-web-group"].replace('content-website-', '');
                    const webRadio = document.querySelector(`input[name="websiteRadio"][value="${webValue}"]`);
                    if (webRadio) webRadio.checked = true;
                }

                // Set website URL
                if (data.langKeyWords["content-group"] && data.langKeyWords["content-group"]["websiteURL"]) {
                    const urlInput = document.getElementById('websiteURL');
                    if (urlInput) urlInput.value = data.langKeyWords["content-group"]["websiteURL"];
                }

                // Set ICT Type checkboxes
                if (data.langKeyWords["ict-group"]) {
                    console.log('Loading ICT types:', data.langKeyWords["ict-group"]);
                    Object.keys(data.langKeyWords["ict-group"]).forEach(key => {
                        const match = key.match(/it-([a-zA-Z-]+)-\d+/);
                        if (match && data.langKeyWords["ict-group"][key] === true) {
                            let value = match[1];
                            console.log('Found ICT type value:', value);
                            // Reverse mapping
                            if (value === 'prod') value = 'products';
                            else if (value === 'serv') value = 'services';
                            console.log('Mapped ICT type value:', value);
                            
                            const checkbox = document.querySelector(`input[name="ictType"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log('Set ICT type checkbox:', value);
                                // Do NOT trigger change event during loading
                            } else {
                                console.log('ICT type checkbox not found:', value);
                            }
                        }
                    });
                }

                // Set Exemptions - handle both radio and checkbox patterns
                if (data.langKeyWords["exemptions-group"]) {
                    console.log('Loading exemptions:', data.langKeyWords["exemptions-group"]);
                    Object.keys(data.langKeyWords["exemptions-group"]).forEach(key => {
                        const match = key.match(/excep-([a-zA-Z-]+)-\d+/);
                        if (match && data.langKeyWords["exemptions-group"][key] === true) {
                            let value = match[1];
                            console.log('Found exemption value:', value);
                            // Reverse mapping for exemptions
                            const exemptionReverseMapping = {
                                'none': 'none',
                                'idk': 'dontKnow',
                                'nat-sec': 'nationalSecurity',
                                'mon-spa': 'ictFunctions',
                                'alter': 'fundamentalAlteration',
                                'fed-con': 'federalContracts',
                                'und-bur': 'undueBurden'
                            };
                            value = exemptionReverseMapping[value] || value;
                            console.log('Mapped exemption value:', value);
                            
                            const radio = document.querySelector(`input[name="exemption"][value="${value}"]`);
                            if (radio) {
                                radio.checked = true;
                                console.log('Set exemption radio:', value);
                            } else {
                                console.log('Exemption radio not found:', value);
                            }
                        }
                    });
                }

                // Set Software Criteria checkboxes
                if (data.langKeyWords["soft-criteria-group"]) {
                    console.log('Loading software criteria:', data.langKeyWords["soft-criteria-group"]);
                    let hasAnyTrueValue = false;
                    Object.keys(data.langKeyWords["soft-criteria-group"]).forEach(key => {
                        const match = key.match(/soft-([a-zA-Z-]+)-\d+/);
                        if (match && data.langKeyWords["soft-criteria-group"][key] === true) {
                            hasAnyTrueValue = true;
                            let value = match[1];
                            console.log('Found software criteria value:', value);
                            // Reverse mapping for software criteria
                            const softwareReverseMapping = {
                                'no-user-interface': 'noUI',
                                'assistive': 'assistiveTech',
                                'idk': 'dontKnow',
                                'none': 'none'
                            };
                            value = softwareReverseMapping[value] || value;
                            console.log('Mapped software criteria value:', value);
                            
                            const checkbox = document.querySelector(`input[name="softwareCriteria"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log('Set software criteria checkbox:', value);
                                // Do NOT trigger change event during loading to avoid none handling interference
                            } else {
                                console.log('Software criteria checkbox not found:', value);
                            }
                        }
                    });
                    
                    // If no true values found, check "none" option
                    if (!hasAnyTrueValue) {
                        console.log('No software criteria selected in JSON, setting none option');
                        const noneCheckbox = document.querySelector(`input[name="softwareCriteria"][value="none"]`);
                        if (noneCheckbox) {
                            noneCheckbox.checked = true;
                            console.log('Set software criteria none checkbox');
                        }
                    }
                }

                // Set Software Purchase Type checkboxes
                if (data.langKeyWords["software-group"]) {
                    console.log('Loading software purchase types:', data.langKeyWords["software-group"]);
                    let hasAnyTrueValue = false;
                    Object.keys(data.langKeyWords["software-group"]).forEach(key => {
                        const match = key.match(/software-([a-zA-Z-]+)-\d+/);
                        if (match && data.langKeyWords["software-group"][key] === true) {
                            hasAnyTrueValue = true;
                            let value = match[1];
                            console.log('Found software purchase type value:', value);
                            if (value === 'web-app') value = 'webDesktopServer';
                            else if (value === 'auth-tool') value = 'authoringTools';
                            else if (value === 'infra') value = 'infrastructure';
                            console.log('Mapped software purchase type value:', value);
                            
                            const checkbox = document.querySelector(`input[name="softwarePurchaseType"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log('Set software purchase type checkbox:', value);
                                // Do NOT trigger change event during loading
                            } else {
                                console.log('Software purchase type checkbox not found:', value);
                            }
                        }
                    });
                    
                    // If no true values found, check "none" option
                    if (!hasAnyTrueValue) {
                        console.log('No software purchase types selected in JSON, setting none option');
                        const noneCheckbox = document.querySelector(`input[name="softwarePurchaseType"][value="none"]`);
                        if (noneCheckbox) {
                            noneCheckbox.checked = true;
                            console.log('Set software purchase type none checkbox');
                        }
                    }
                }

                // Set Cloud Service Type checkboxes
                if (data.langKeyWords["soft-serv-group"]) {
                    Object.keys(data.langKeyWords["soft-serv-group"]).forEach(key => {
                        const match = key.match(/soft-serv-(\w+)-/);
                        if (match && data.langKeyWords["soft-serv-group"][key] === true) {
                            let value = match[1];
                            if (value === 'saas') value = 'SaaS';
                            else if (value === 'paas') value = 'PaaS';
                            else if (value === 'idk') value = 'dontKnow';
                            
                            const checkbox = document.querySelector(`input[name="cloudServiceType"][value="${value}"]`);
                            if (checkbox) checkbox.checked = true;
                        }
                    });
                }

                // Set software web browser
                if (data.langKeyWords["soft-web-group"] && data.langKeyWords["soft-web-group"]["soft-web-group"]) {
                    const webValue = data.langKeyWords["soft-web-group"]["soft-web-group"].replace('soft-web-', '');
                    const webRadio = document.querySelector(`input[name="softwareWebBrowser"][value="${webValue}"]`);
                    if (webRadio) webRadio.checked = true;
                }

                // Set authoring tool
                if (data.langKeyWords["soft-create-group"] && data.langKeyWords["soft-create-group"]["soft-create-group"]) {
                    const createValue = data.langKeyWords["soft-create-group"]["soft-create-group"].replace('soft-create-', '');
                    const createRadio = document.querySelector(`input[name="authoringTool"][value="${createValue}"]`);
                    if (createRadio) createRadio.checked = true;
                }

                // Set Hardware Type checkboxes
                if (data.langKeyWords["hardware-group"]) {
                    console.log('Loading hardware:', data.langKeyWords["hardware-group"]);
                    let hasAnyTrueValue = false;
                    Object.keys(data.langKeyWords["hardware-group"]).forEach(key => {
                        const match = key.match(/hardware-([a-zA-Z-]+)-\d+/);
                        if (match && data.langKeyWords["hardware-group"][key] === true) {
                            hasAnyTrueValue = true;
                            let value = match[1];
                            console.log('Found hardware value:', value);
                            // Reverse mapping for hardware
                            const hardwareReverseMapping = {
                                'computer': 'computers',
                                'tablet': 'tablet',
                                'printer': 'printers',
                                'multi-func': 'multiFunction',
                                'peripheral': 'peripheral',
                                'kiosk': 'kiosks',
                                'mobile': 'mobile',
                                'video-telecon': 'videoConf',
                                'video-monitor': 'videoDisplay',
                                'server': 'servers',
                                'other': 'other',
                                'none': 'none'
                            };
                            value = hardwareReverseMapping[value] || value;
                            console.log('Mapped hardware value:', value);
                            
                            const checkbox = document.querySelector(`input[name="hardwareType"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                console.log('Set hardware checkbox:', value);
                                // Do NOT trigger change event during loading
                            } else {
                                console.log('Hardware checkbox not found:', value);
                            }
                        }
                    });
                    
                    // If no true values found, check "none" option
                    if (!hasAnyTrueValue) {
                        console.log('No hardware selected in JSON, setting none option');
                        const noneCheckbox = document.querySelector(`input[name="hardwareType"][value="none"]`);
                        if (noneCheckbox) {
                            noneCheckbox.checked = true;
                            console.log('Set hardware none checkbox');
                        }
                    }
                }

                // Set server installation (if server-iaas-group has data)
                if (data.langKeyWords["server-iaas-group"] && data.langKeyWords["server-iaas-group"]["server-iaas-group"]) {
                    const serverValue = data.langKeyWords["server-iaas-group"]["server-iaas-group"].replace('server-iaas-', '');
                    const serverRadio = document.querySelector(`input[name="serverInstallation"][value="${serverValue}"]`);
                    if (serverRadio) serverRadio.checked = true;
                }

                // Set Support Type checkboxes
                if (data.langKeyWords["support-doc-group"]) {
                    Object.keys(data.langKeyWords["support-doc-group"]).forEach(key => {
                        const match = key.match(/support-(\w+)-/);
                        if (match && data.langKeyWords["support-doc-group"][key] === true) {
                            let value = match[1];
                            if (value === 'tech') value = 'selfService';
                            else if (value === 'call') value = 'helpDesk';
                            else if (value === 'doc') value = 'productDoc';
                            else if (value === 'train') value = 'training';
                            
                            const checkbox = document.querySelector(`input[name="supportType"][value="${value}"]`);
                            if (checkbox) checkbox.checked = true;
                        }
                    });
                }

                // Update conditional visibility after loading data
                updateWebContentVisibility();
                updateSoftwareQuestionsVisibility();
                updateServerInstallationVisibility();
                
                // Debug: Log final state of all form sections
                console.log('=== FINAL FORM STATE ===');
                console.log('Exemptions checked:', document.querySelector('input[name="exemption"]:checked')?.value);
                console.log('Software criteria checked:', Array.from(document.querySelectorAll('input[name="softwareCriteria"]:checked')).map(cb => cb.value));
                console.log('Software purchase types checked:', Array.from(document.querySelectorAll('input[name="softwarePurchaseType"]:checked')).map(cb => cb.value));
                console.log('Hardware types checked:', Array.from(document.querySelectorAll('input[name="hardwareType"]:checked')).map(cb => cb.value));
                console.log('Cloud service question visible:', cloudServiceQuestion.style.display !== 'none');
                console.log('Web browser software question visible:', webBrowserSoftwareQuestion.style.display !== 'none');
                console.log('Authoring tool question visible:', authoringToolQuestion.style.display !== 'none');
            }

            // Save form data to JSON file
            saveDataBtn.addEventListener('click', function() {
                const formData = collectFormData();
                const dataStr = JSON.stringify(formData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                // Create filename using project name
                const projectName = projectNameInput.value.trim();
                const sanitizedProjectName = projectName.replace(/[^a-zA-Z0-9\-_]/g, '_'); // Replace invalid filename characters
                const filename = projectName ? `ART-${sanitizedProjectName}.json` : `ART-form-data-${new Date().toISOString().split('T')[0]}.json`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = filename;
                link.click();
                
                URL.revokeObjectURL(link.href);
                alert('Form data saved successfully!');
            });

            // Load form data from JSON file
            loadDataBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && file.type === 'application/json') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            console.log('Loading JSON data:', data);
                            populateFormFromData(data);
                            console.log('Form populated, updating visibility...');
                            // Force update conditional visibility after a short delay
                            setTimeout(() => {
                                updateWebContentVisibility();
                                updateSoftwareQuestionsVisibility();
                                updateServerInstallationVisibility();
                                console.log('Conditional visibility updated');
                            }, 100);
                            alert('Form data loaded successfully!');
                        } catch (error) {
                            alert('Error loading JSON file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                } else {
                    alert('Please select a valid JSON file.');
                }
                // Reset file input
                fileInput.value = '';
            });

            // --- Initial State and Event Listeners for Conditional Questions ---

            // Function to update visibility of webContentQuestion
            function updateWebContentVisibility() {
                const selectedEContent = document.querySelector('input[name="eContent"]:checked');
                // Corrected ID: The fieldset for "Will this electronic content be made available through a website?" is inside the "Electronic Content" section and does not have an ID 'webContentQuestion'. It's within a fieldset with aria-labelledby="websiteQuestion". We need to select the outer fieldset if it's meant to be toggled, or the specific container for the URL input.
                // Looking at the provided HTML, the fieldset already has display:flex. Only the #websiteInputContainer is hidden/shown.
                const websiteInputContainer = document.getElementById('websiteInputContainer');
                const websiteRadios = document.querySelectorAll('input[name="websiteRadio"]');

                if (selectedEContent && selectedEContent.value === 'yes') {
                    // Check if 'websiteYes' radio button is selected
                    const websiteYesRadio = document.getElementById('websiteYes');
                    if (websiteYesRadio && websiteYesRadio.checked) {
                        websiteInputContainer.style.display = 'block';
                    } else {
                        websiteInputContainer.style.display = 'none';
                        // Keep radios checked, but hide the input if no website
                    }

                    // Ensure websiteRadio is shown if eContent is 'yes'
                    websiteRadios.forEach(radio => radio.closest('.form-check-inline').style.display = ''); // Show all radio options
                    document.querySelector('fieldset[aria-labelledby="websiteQuestion"]').style.display = 'flex'; // Show the fieldset itself
                } else {
                    document.querySelector('fieldset[aria-labelledby="websiteQuestion"]').style.display = 'none'; // Hide the entire website question
                    websiteInputContainer.style.display = 'none';
                    // Reset website radio selection when hidden
                    websiteRadios.forEach(radio => radio.checked = false);
                    document.getElementById('websiteURL').value = ''; // Clear URL
                }
            }


            // Function to update visibility of software-related conditional questions
            function updateSoftwareQuestionsVisibility() {
                const selectedSoftwareTypes = Array.from(softwarePurchaseTypes)
                                                        .filter(cb => cb.checked && cb.value !== 'none')
                                                        .map(cb => cb.value);

                const hasSoftwarePurchase = selectedSoftwareTypes.length > 0;
                const isAuthoringToolSelected = selectedSoftwareTypes.includes('authoringTools');
                const isWebOrAuthoringSoftwareSelected = selectedSoftwareTypes.includes('webDesktopServer') || isAuthoringToolSelected || selectedSoftwareTypes.includes('infrastructure');


                cloudServiceQuestion.style.display = hasSoftwarePurchase ? 'block' : 'none';
                if (!hasSoftwarePurchase) document.querySelectorAll('input[name="cloudServiceType"]').forEach(cb => cb.checked = false);

                webBrowserSoftwareQuestion.style.display = isWebOrAuthoringSoftwareSelected ? 'block' : 'none';
                if (!isWebOrAuthoringSoftwareSelected) document.querySelectorAll('input[name="softwareWebBrowser"]').forEach(radio => radio.checked = false);

                authoringToolQuestion.style.display = isAuthoringToolSelected ? 'block' : 'none';
                if (!isAuthoringToolSelected) document.querySelectorAll('input[name="authoringTool"]').forEach(radio => radio.checked = false);
            }

            // Function to update visibility of serverInstallationQuestion
            function updateServerInstallationVisibility() {
                const isServerSelected = Array.from(hardwareTypeCheckboxes).some(cb => cb.checked && cb.value === 'servers');
                if (isServerSelected) {
                    serverInstallationQuestion.style.display = 'block';
                } else {
                    serverInstallationQuestion.style.display = 'none';
                    // Reset radio selection when hidden
                    document.querySelectorAll('input[name="serverInstallation"]').forEach(radio => radio.checked = false);
                }
            }

            // Add event listeners for conditional display
            eContentRadios.forEach(radio => {
                radio.addEventListener('change', updateWebContentVisibility);
            });
            // Listener for websiteRadio to show/hide the URL input
            document.querySelectorAll('input[name="websiteRadio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const websiteInputContainer = document.getElementById('websiteInputContainer');
                    if (this.value === 'yes') {
                        websiteInputContainer.style.display = 'block';
                    } else {
                        websiteInputContainer.style.display = 'none';
                        document.getElementById('websiteURL').value = ''; // Clear URL if "No" is selected
                    }
                });
            });

            softwarePurchaseTypes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSoftwareQuestionsVisibility);
            });
            hardwareTypeCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateServerInstallationVisibility);
            });


            // Function to handle "None of the above" selections
            function handleNoneSelection(noneCheckbox, groupName) {
                const groupElements = document.querySelectorAll(`input[name="${groupName}"]`);
                
                if (noneCheckbox.checked) {
                    // If "None" is checked, uncheck all other options
                    groupElements.forEach(element => {
                        if (element !== noneCheckbox) {
                            element.checked = false;
                        }
                    });
                } else {
                    // If "None" is unchecked, and no other option is selected, re-check "None"
                    // This prevents a state where nothing is selected for a checkbox group intended to have a default/none.
                    const anyOtherChecked = Array.from(groupElements).some(el => el.checked && el !== noneCheckbox);
                    if (!anyOtherChecked) {
                         noneCheckbox.checked = true;
                    }
                }
                // Always trigger updates for conditional questions related to this group
                if (groupName === 'ictType') updateWebContentVisibility();
                if (groupName === 'softwarePurchaseType') updateSoftwareQuestionsVisibility();
                if (groupName === 'hardwareType') updateServerInstallationVisibility();
            }

            // Function to handle regular checkbox selections (uncheck "None" if other items are selected)
            function handleRegularSelection(checkbox, groupName) {
                const noneCheckbox = document.querySelector(`input[name="${groupName}"][value="none"]`);
                
                if (checkbox.checked && noneCheckbox && noneCheckbox.checked) {
                    // If another option is checked and "None" was previously checked, uncheck "None"
                    noneCheckbox.checked = false;
                }
                // If a non-none checkbox is unchecked, check if all others are now unchecked, then set 'none'
                const groupElements = document.querySelectorAll(`input[name="${groupName}"]`);
                const anyOtherChecked = Array.from(groupElements).some(el => el.checked && el.value !== 'none');
                if (!anyOtherChecked && noneCheckbox) {
                    noneCheckbox.checked = true;
                }

                // Always trigger updates for conditional questions related to this group
                if (groupName === 'ictType') updateWebContentVisibility();
                if (groupName === 'softwarePurchaseType') updateSoftwareQuestionsVisibility();
                if (groupName === 'hardwareType') updateServerInstallationVisibility();
            }

            // Add event listeners for "None of the above" functionality
            function setupNoneHandling() {
                const checkboxGroupNames = ['ictType', 'softwareCriteria', 'softwarePurchaseType', 'hardwareType', 'supportType', 'cloudServiceType'];
                
                checkboxGroupNames.forEach(groupName => {
                    const noneCheckbox = document.querySelector(`input[name="${groupName}"][value="none"]`);
                    const groupCheckboxes = document.querySelectorAll(`input[name="${groupName}"]`);

                    if (noneCheckbox) {
                        noneCheckbox.addEventListener('change', () => handleNoneSelection(noneCheckbox, groupName));
                        groupCheckboxes.forEach(checkbox => {
                            if (checkbox !== noneCheckbox) {
                                checkbox.addEventListener('change', () => handleRegularSelection(checkbox, groupName));
                            }
                        });
                    }
                });
            }

            // --- Form Submission Logic ---
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Prevent default form submission

                const projectName = projectNameInput.value.trim();

                // Project Name Validation
                if (!projectName) {
                    projectNameError.style.display = 'block'; // Show error message
                    projectNameError.setAttribute('aria-live', 'assertive');
                    projectNameInput.focus(); // Focus on the field for the user
                    projectNameInput.setAttribute('aria-invalid', 'true');
                    outputDiv.innerHTML = `<p style="text-align: center; color: #666;">Please fill out the required fields.</p>`; // Clear output or show a prompt
                    return; // Stop the function if validation fails
                } else {
                    projectNameError.style.display = 'none'; // Hide error if valid
                    projectNameInput.setAttribute('aria-invalid', 'false');
                }

                let outputText = ``;

                // Get the selected solicitation phase
                const solicitationPhase = document.querySelector('input[name="solicitationPhase"]:checked')?.value;

                // Enhanced Header with Clean Reference-Based Approach
                outputText += `Accessibility Requirements for Information and Communication Technology (ICT) Procurement\n`;
                outputText += `These requirements set clear accessibility expectations for all procured Information and Communication Technology (ICT), ensuring compliance with federal standards and promoting inclusive design.\n\n`;
                
                // Core Accessibility Standards Section
                outputText += `Core Accessibility Standards\n`;
                outputText += `All ICT deliverables, development, and support services under this contract must meet these foundational standards:\n\n`;
                
                outputText += `Legal Compliance: All deliverables shall comply with Section 508 of the Rehabilitation Act (29 U.S.C. §794d), as detailed by the U.S. Access Board.\n\n`;
                outputText += `Reference: https://www.access-board.gov/ict/\n\n`;
                
                outputText += `Best Practice Standards: For all web-based ICT and electronic content, the Contractor shall meet the Web Content Accessibility Guidelines (WCAG) 2.2 Level AA recommendations.\n\n`;
                outputText += `Reference: https://www.w3.org/TR/WCAG22/\n\n`;
                
                outputText += `Accessibility Conformance Reporting: The Contractor shall provide Accessibility Conformance Reports (ACRs) for all digital deliverables using the OpenACR Editor.\n\n`;
                outputText += `Reference: https://acreditor.section508.gov/\n\n`;
                outputText += `Submission Requirement: Both the machine-readable YAML file and the HTML version of the ACR must be included in the submission. PDFs will not be accepted.\n\n`;

                outputText += `Project-Specific Accessibility Requirements\n`;
                outputText += `The Contractor shall ensure that all procured ICT provides comparable access to information and data for people with disabilities, in accordance with Section 508.\n\n`;
                outputText += `Item: ${projectName}\n\n`;

                // Get form responses
                const ictTypeProducts = document.getElementById('ictProduct').checked;
                const ictTypeServices = document.getElementById('ictService').checked;
                const eContentAnswer = document.querySelector('input[name="eContent"]:checked')?.value;
                const webContentAnswer = document.querySelector('input[name="websiteRadio"]:checked')?.value; // Corrected name for web content radio

                // Electronic Content Requirements
                if (eContentAnswer === 'yes') {
                    outputText += `1. Electronic Content & Software Accessibility\n`;
                    outputText += `The Contractor shall ensure all electronic content (e.g., forms, documents, multimedia, templates, official communications) and all software with user interfaces (including web-based software) meet WCAG 2.2 Level AA standards and the following Section 508 requirements:\n\n`;
                    
                    outputText += `Electronic Content: Compliance with E205 Electronic Content.\n\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#E205\n\n`;
                    
                    outputText += `Software: Compliance with E207 Software.\n\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#E207\n\n`;
                    
                    outputText += `Key expectation: All public-facing content must be fully accessible and compatible with assistive technologies. Alternative formats must be provided upon request. Accessibility performance must be maintained across devices and platforms.\n\n`;
                    
                    if (webContentAnswer === 'yes') {
                        outputText += `Web Content Enhancement: For web-delivered content, contractor should target the latest WCAG recommendations to ensure future-ready accessibility beyond minimum compliance.\n\n`;
                    }
                }

                // E206 Hardware
                const selectedHardwareTypes = Array.from(document.querySelectorAll('input[name="hardwareType"]:checked'))
                                                        .map(cb => cb.value)
                                                        .filter(val => val !== 'none');
                const serverInstallationAnswer = document.querySelector('input[name="serverInstallation"]:checked')?.value;

                if (selectedHardwareTypes.length > 0) {
                    outputText += `E206 Hardware\n`;
                    outputText += `E206.1 General. Where components of ICT are hardware and transmit information or have a user interface, such components shall conform to the requirements in Chapter 4.\n\n`;

                    // Chapter 4 sections - carefully define conditions
                    outputText += `401 General\n`;
                    outputText += `401.1 Scope. The requirements of Chapter 4 shall apply to ICT that is hardware where required by 508 Chapter 2 (Scoping Requirements), 255 Chapter 2 (Scoping Requirements), and where otherwise referenced in any other chapter of the Revised 508 Standards or Revised 255 Guidelines.\n`;
                    outputText += `Exception from E401.1 Scope: Hardware that is assistive technology shall not be required to conform to the requirements of this chapter.\n\n`;

                    const hasDisplayScreenHardware = selectedHardwareTypes.includes('computers') || selectedHardwareTypes.includes('tablet') || selectedHardwareTypes.includes('printers') || selectedHardwareTypes.includes('multiFunction') || selectedHardwareTypes.includes('informationKiosks') || selectedHardwareTypes.includes('videoDisplay') || selectedHardwareTypes.includes('videoConf');
                    const hasOperablePartsHardware = selectedHardwareTypes.includes('computers') || selectedHardwareTypes.includes('tablet') || selectedHardwareTypes.includes('printers') || selectedHardwareTypes.includes('multiFunction') || selectedHardwareTypes.includes('peripheral') || selectedHardwareTypes.includes('kiosks') || selectedHardwareTypes.includes('mobile') || selectedHardwareTypes.includes('videoConf') || selectedHardwareTypes.includes('videoDisplay');
                    const hasTwoWayVoiceHardware = selectedHardwareTypes.includes('mobile') || selectedHardwareTypes.includes('videoConf') || selectedHardwareTypes.includes('kiosks'); // Kiosks can have voice comm

                    if (hasOperablePartsHardware) {
                        outputText += `Operable Parts: All operable parts used in the normal operation of ICT hardware must conform to Section 407 of the Revised 508 Standards.\n`;
                        outputText += `Reference: https://www.access-board.gov/ict/#407\n\n`;
                    }

                    if (hasDisplayScreenHardware) {
                        outputText += `Display Screens: All display screens must conform to Section 408 of the Revised 508 Standards.\n`;
                        outputText += `Reference: https://www.access-board.gov/ict/#408\n\n`;
                    }

                    if (selectedHardwareTypes.includes('kiosks') || selectedHardwareTypes.includes('multiFunction') || selectedHardwareTypes.includes('printers')) { // Add other closed functionality devices
                        outputText += `Closed Functionality: All ICT with closed functionality (e.g., kiosks, multifunction devices, printers) must conform to Section 402 of the Revised 508 Standards.\n`;
                        outputText += `Reference: https://www.access-board.gov/ict/#402\n\n`;
                    }

                    if (hasTwoWayVoiceHardware) {
                        outputText += `Two-Way Voice Communication: All ICT that provides two-way voice communication must conform to Section 412 of the Revised 508 Standards.\n`;
                        outputText += `Reference: https://www.access-board.gov/ict/#412\n\n`;
                    }

                    if (selectedHardwareTypes.includes('videoConf') || selectedHardwareTypes.includes('videoDisplay')) {
                        outputText += `Video Display and Captioning: All ICT that displays or processes video with synchronized audio must conform to Sections 413, 414, and 415 of the Revised 508 Standards.\n`;
                        outputText += `References: https://www.access-board.gov/ict/#413, https://www.access-board.gov/ict/#414, https://www.access-board.gov/ict/#415\n\n`;
                    }
                    // These generally apply if any hardware is selected, as they are broad principles.
                    outputText += `Biometrics: All biometric features must conform to Section 403 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#403\n\n`;
                    outputText += `Preservation of Accessibility Information: ICT that transmits or converts information must conform to Section 404 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#404\n\n`;
                    outputText += `Privacy: All ICT must provide the same degree of privacy of input and output to all individuals, conforming to Section 405 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#405\n\n`;
                    outputText += `Standard Connections: Data connections for input and output must conform to Section 406 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#406\n\n`;
                    outputText += `Status Indicators: Where provided, status indicators must conform to Section 409 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#409\n\n`;
                    outputText += `Color Coding: Color coding must not be used as the only means of conveying information, conforming to Section 410 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#410\n\n`;
                    outputText += `Audible Signals: Where provided, audible signals or cues must conform to Section 411 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#411\n\n`;
                }

                // Software Requirements
                const selectedSoftwareCriteria = Array.from(document.querySelectorAll('input[name="softwareCriteria"]:checked'))
                                                             .map(cb => cb.value);
                const selectedSoftwarePurchaseTypes = Array.from(document.querySelectorAll('input[name="softwarePurchaseType"]:checked'))
                                                                 .map(cb => cb.value)
                                                                 .filter(val => val !== 'none');
                const softwareWebBrowserAnswer = document.querySelector('input[name="softwareWebBrowser"]:checked')?.value;
                const authoringToolAnswer = document.querySelector('input[name="authoringTool"]:checked')?.value;

                if (selectedSoftwarePurchaseTypes.length > 0 && !selectedSoftwareCriteria.includes('assistiveTech')) {
                    outputText += `Software Accessibility Requirements\n`;
                    outputText += `Contractor must ensure all software with user interfaces meets Section 508 software standards detailed at https://www.access-board.gov/ict/#E207\n\n`;
                    
                    outputText += `Core Software Requirements:\n`;
                    outputText += `• All user interfaces must comply with WCAG 2.2 Level AA standards\n`;
                    outputText += `• Software must be compatible with assistive technologies\n`;
                    outputText += `• Platform accessibility features must be preserved and enhanced\n`;
                    outputText += `• User preferences for accessibility settings must be supported\n\n`;

                    if (softwareWebBrowserAnswer === 'yes') {
                        outputText += `Web-Based Software Enhancement:\n`;
                        outputText += `For web-accessible software, contractor should target the latest WCAG recommendations to ensure future compatibility and enhanced user experience.\n\n`;
                    }

                    if (authoringToolAnswer === 'yes' || selectedSoftwarePurchaseTypes.includes('authoringTools')) {
                        outputText += `Authoring Tools Requirements:\n`;
                        outputText += `Content creation tools must:\n`;
                        outputText += `• Enable creation of accessible content that meets WCAG 2.2 standards\n`;
                        outputText += `• Provide accessibility guidance and prompts to content creators\n`;
                        outputText += `• Include accessible templates and preserve accessibility features during format conversion\n`;
                        outputText += `• Support PDF/UA export when PDF functionality is provided\n\n`;
                    }

                    if (selectedSoftwarePurchaseTypes.includes('webDesktopServer') || selectedSoftwarePurchaseTypes.includes('infrastructure')) {
                        outputText += `Integration & Performance Requirements:\n`;
                        outputText += `• Maintain accessibility performance across different devices and platforms\n`;
                        outputText += `• Ensure accessibility features work reliably in production environments\n`;
                        outputText += `• Provide automated accessibility testing capabilities where feasible\n\n`;
                    }
                }

                // E208 Support Documentation and Services
                const selectedSupportTypes = Array.from(document.querySelectorAll('input[name="supportType"]:checked'))
                                                         .map(cb => cb.value)
                                                         .filter(val => val !== 'none');

                if (selectedSupportTypes.length > 0) {
                    outputText += `Support Documentation and Services: All support documentation and services for ICT must conform to Section E208 and Chapter 6 of the Revised 508 Standards.\n`;
                    outputText += `Reference: https://www.access-board.gov/ict/#E208\n`;
                    outputText += `Chapter 6 Reference: https://www.access-board.gov/ict/#chapter-6-support-documentation-and-services\n\n`;
                }

                // E301 General (Functional Performance Criteria)
                // This section generally applies if ICT products are involved and specific functional needs are identified.
                // Include if any ICT product (hardware/software/electronic content) is selected OR if ICT Services are selected, as services can involve products.
                if (ictTypeProducts || ictTypeServices || eContentAnswer === 'yes' || selectedSoftwarePurchaseTypes.length > 0 || selectedHardwareTypes.length > 0) {
                    outputText += `Functional Performance Criteria Requirements\n`;
                    outputText += `All ICT must meet the Functional Performance Criteria detailed in Section 508 Standards Chapter 3 (https://www.access-board.gov/ict/#chapter-3-functional-performance-criteria) to ensure usability by individuals with disabilities across all functional capabilities including:\n\n`;
                    outputText += `• Vision capabilities (with or without vision, with limited vision, without color perception)\n`;
                    outputText += `• Hearing capabilities (with or without hearing, with limited hearing)\n`;
                    outputText += `• Speech capabilities (with or without speech)\n`;
                    outputText += `• Motor capabilities (with limited manipulation, with limited reach and strength)\n`;
                    outputText += `• Cognitive capabilities (with limited language, cognitive, and learning abilities)\n\n`;
                }

                // Enhanced Procurement and Lifecycle Management Requirements
                // Include these enhanced requirements for all ICT procurements
                if (ictTypeProducts || ictTypeServices || eContentAnswer === 'yes' || selectedSoftwarePurchaseTypes.length > 0 || selectedHardwareTypes.length > 0 || selectedSupportTypes.length > 0) {
                    outputText += `VENDOR ACCOUNTABILITY AND PROCUREMENT EXCELLENCE\n\n`;
                    
                    outputText += `Evaluation Criteria – Accessibility and Inclusive Design\n\n`;
                    outputText += `Proposals submitted under this contract will be evaluated on how well they:\n`;
                    outputText += `• Demonstrate a comprehensive understanding of, and commitment to, the latest WCAG recommendations and applicable Section 508 standards\n`;
                    outputText += `• Outline a detailed plan for integrating accessibility throughout the entire project lifecycle, from initial design and development to rigorous testing, secure deployment, and ongoing maintenance\n`;
                    outputText += `• Provide compelling evidence of extensive experience in designing, developing, and testing accessible ICT, including direct engagement and usability testing with individuals with diverse disabilities\n`;
                    outputText += `• Describe robust methodologies for continuous monitoring, proactive identification, and timely remediation of accessibility issues, including the use of both automated tools and expert manual review\n`;
                    outputText += `• Detail comprehensive strategies for providing accessible user support, documentation, and training, ensuring information is available in multiple accessible formats\n`;
                    outputText += `• Present internal organizational policies, staff training programs, and quality assurance processes that demonstrate a sustained commitment to digital accessibility\n`;
                    outputText += `• Vendors may be required to demonstrate the use of their product with assistive technologies prior to a final decision being made. \n\n`;


                    outputText += `Accessibility Deliverables\n\n`;
                    outputText += `Required deliverables for ICT projects under this contract include:\n`;
                    outputText += `• An Accessibility Conformance Report (ACR) for all new or significantly modified ICT, completed using the latest version of OpenACR, demonstrating conformance with the latest WAI WCAG recommendations at Level AA\n`;
                    outputText += `• Detailed accessibility testing documentation, including results from automated and manual testing, and usability testing with individuals with disabilities\n`;
                    outputText += `• All user-facing documentation, training materials, and support resources must be provided in accessible formats\n`;
                    outputText += `• A plan for ongoing accessibility maintenance, including regular audits, monitoring tools, and remediation processes\n`;
                    outputText += `• Documentation of any third-party components used and their accessibility status\n`;
                    outputText += `• Where open source components are used, documentation of contributions of accessibility-related improvements to the relevant upstream open source projects. Information on this should be covered in regular reporting.\n\n`;
                    
                    outputText += `Ongoing Accessibility Compliance and Maintenance\n\n`;
                    outputText += `The Contractor must:\n`;
                    outputText += `• Proactively monitor newly released accessibility standards, guidelines, and best practices, adapting processes as necessary to maintain compliance with evolving requirements (e.g., It is a best practice to build to the latest WCAG recommendations from the Web Accessibility Initiative.)\n`;
                    outputText += `• Establish and adhere to a process for promptly identifying, reporting, documenting, and prioritizing accessibility barriers, including regressions caused by code changes, and remediating them based on their impact\n`;
                    outputText += `• Provide training to project personnel on accessibility principles, development techniques, and testing methodologies relevant to their roles\n`;
                    outputText += `• Maintain clear documentation of accessibility features, known issues, and planned remediation efforts\n`;
                    outputText += `• Ensure that all updates, upgrades, and changes to the ICT maintain or improve its accessibility conformance\n`;
                    outputText += `• If COTS software (including open source software) is used, ensure that accessibility bugs and patches are contributed back upstream.\n\n`;
                }

                // Display the generated output with edit capability
                displayOutput(outputText);
            });

            // Store previous criteria for comparison
            let previousCriteria = null;

            // Function to get current form criteria
            function getCurrentCriteria() {
                const criteria = {
                    projectName: document.getElementById('projectName').value.trim(),
                    solicitationPhase: document.querySelector('input[name="solicitationPhase"]:checked')?.value, // Added
                    ictProducts: document.getElementById('ictProduct').checked,
                    ictServices: document.getElementById('ictService').checked,
                    eContent: document.querySelector('input[name="eContent"]:checked')?.value,
                    webContent: document.querySelector('input[name="websiteRadio"]:checked')?.value, // Corrected name
                    websiteURL: document.getElementById('websiteURL')?.value, // Added
                    hardwareTypes: Array.from(document.querySelectorAll('input[name="hardwareType"]:checked')).map(cb => cb.value).filter(val => val !== 'none'),
                    softwarePurchaseTypes: Array.from(document.querySelectorAll('input[name="softwarePurchaseType"]:checked')).map(cb => cb.value).filter(val => val !== 'none'),
                    softwareCriteria: Array.from(document.querySelectorAll('input[name="softwareCriteria"]:checked')).map(cb => cb.value),
                    supportTypes: Array.from(document.querySelectorAll('input[name="supportType"]:checked')).map(cb => cb.value).filter(val => val !== 'none'),
                    authoringTool: document.querySelector('input[name="authoringTool"]:checked')?.value,
                    serverInstallation: document.querySelector('input[name="serverInstallation"]:checked')?.value,
                    exemption: document.querySelector('input[name="exemption"]:checked')?.value, // Added
                    cloudServiceType: Array.from(document.querySelectorAll('input[name="cloudServiceType"]:checked')).map(cb => cb.value).filter(val => val !== 'none'), // Added
                    softwareWebBrowser: document.querySelector('input[name="softwareWebBrowser"]:checked')?.value // Added
                };
                return criteria;
            }

            // Function to generate criteria summary
            function generateCriteriaSummary(criteria, changes = null) {
                let summary = '<div style="background-color: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; margin-bottom: 15px;">';
                summary += '<h3 style="margin-top: 0; color: #495057;">Requirements Generated Based On:</h3>';
                summary += '<ul style="margin-bottom: 10px;">';
                
                // Project details
                summary += `<li><strong>Project Name:</strong> ${criteria.projectName}</li>`;
                
                // Solicitation Phase
                const solicitationPhaseLabels = {
                    'projectPlanning': 'Project Planning',
                    'marketResearch': 'Market Research',
                    'solicitationDevelopment': 'Solicitation Development'
                };
                const currentSolicitationPhase = solicitationPhaseLabels[criteria.solicitationPhase] || criteria.solicitationPhase;
                const isPhaseChanged = changes && changes.solicitationPhase;
                summary += `<li><strong>Solicitation Phase:</strong> ${currentSolicitationPhase} ${isPhaseChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;

                // ICT Type
                const ictTypes = [];
                if (criteria.ictProducts) ictTypes.push('ICT Products');
                if (criteria.ictServices) ictTypes.push('ICT Services');
                // If "None of the above" for ICT type is checked AND no other ICT type is checked, display "None"
                if (document.getElementById('ictNone').checked && !criteria.ictProducts && !criteria.ictServices) {
                     ictTypes.push('None of the above');
                }
                if (ictTypes.length > 0) {
                    const isChanged = changes && (changes.ictProducts || changes.ictServices);
                    summary += `<li><strong>ICT Type:</strong> ${ictTypes.join(', ')} ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                }
                
                // Exemptions & Exceptions
                const exemptionLabels = {
                    'none': 'No exemptions apply',
                    'dontKnow': 'I don’t have one / I don’t know',
                    'nationalSecurity': 'National Security Exemption',
                    'ictFunctions': 'ICT Functions Located in Maintenance and Monitoring Spaces Exception',
                    'fundamentalAlteration': 'Fundamental Alteration Exception',
                    'federalContracts': 'Federal Contracts Exception',
                    'undueBurden': 'Undue Burden Exception'
                };
                const currentExemption = exemptionLabels[criteria.exemption] || criteria.exemption;
                const isExemptionChanged = changes && changes.exemption;
                summary += `<li><strong>Exemption/Exception:</strong> ${currentExemption} ${isExemptionChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;

                // Electronic Content
                if (criteria.eContent === 'yes') {
                    const isEContentChanged = changes && changes.eContent;
                    let eContentDetails = 'Yes';
                    if (criteria.webContent) {
                        eContentDetails += ` (${criteria.webContent === 'yes' ? 'Web-based' : 'Non-web-based'})`;
                    }
                    if (criteria.webContent === 'yes' && criteria.websiteURL) {
                        eContentDetails += ` - URL: ${criteria.websiteURL}`;
                    }
                    summary += `<li><strong>Electronic Content:</strong> ${eContentDetails} ${isEContentChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                } else {
                    const isEContentChanged = changes && changes.eContent;
                    summary += `<li><strong>Electronic Content:</strong> No ${isEContentChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                }
                
                // Software Criteria (Does the software meet any of the following criteria?)
                const softwareCriteriaLabels = {
                    'noUI': 'Does not have an end-user interface',
                    'assistiveTech': 'Principal function is assistive technology',
                    'dontKnow': 'I don’t know',
                    'none': 'None of the above'
                };
                const currentSoftwareCriteria = criteria.softwareCriteria.map(val => softwareCriteriaLabels[val] || val).join(', ');
                const isSoftwareCriteriaChanged = changes && changes.softwareCriteria;
                summary += `<li><strong>Software Criteria:</strong> ${currentSoftwareCriteria || 'None Selected'} ${isSoftwareCriteriaChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;

                // Software Purchase Type
                if (criteria.softwarePurchaseTypes.length > 0) {
                    const isChanged = changes && changes.softwarePurchaseTypes;
                    const softwareLabels = {
                        'webDesktopServer': 'Web/desktop/server/mobile client applications',
                        'authoringTools': 'Software authoring tools and platforms',
                        'infrastructure': 'Software Infrastructure',
                        'other': 'Other Software'
                    };
                    const softwareList = criteria.softwarePurchaseTypes.map(type => softwareLabels[type] || type).join(', ');
                    summary += `<li><strong>Software Purchased:</strong> ${softwareList} ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                } else {
                     const isChanged = changes && changes.softwarePurchaseTypes;
                     summary += `<li><strong>Software Purchased:</strong> None of the above ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                }

                // Cloud Service Type (if software is purchased)
                if (criteria.softwarePurchaseTypes.length > 0 && criteria.cloudServiceType.length > 0) {
                     const cloudServiceLabels = {
                         'SaaS': 'Software as a Service (SaaS)',
                         'PaaS': 'Platform as a Service (PaaS)',
                         'other': 'Other Cloud Services arrangement',
                         'dontKnow': 'I don\'t know'
                     };
                     const currentCloudServices = criteria.cloudServiceType.map(val => cloudServiceLabels[val] || val).join(', ');
                     const isCloudServiceChanged = changes && changes.cloudServiceType;
                     summary += `<li><strong>Cloud Service Type:</strong> ${currentCloudServices} ${isCloudServiceChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                 } else if (criteria.softwarePurchaseTypes.length > 0) { // If software is purchased but none of the cloud types were selected explicitly
                     const isCloudServiceChanged = changes && changes.cloudServiceType;
                     summary += `<li><strong>Cloud Service Type:</strong> None of the above ${isCloudServiceChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                 }

                 // Software Web Browser accessibility
                 if (criteria.softwarePurchaseTypes.includes('webDesktopServer') || criteria.softwarePurchaseTypes.includes('authoringTools') || criteria.softwarePurchaseTypes.includes('infrastructure')) {
                     const isSoftwareWebBrowserChanged = changes && changes.softwareWebBrowser;
                     summary += `<li><strong>Software accessible via web browser:</strong> ${criteria.softwareWebBrowser === 'yes' ? 'Yes' : (criteria.softwareWebBrowser === 'no' ? 'No' : 'Not specified')} ${isSoftwareWebBrowserChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                 }

                 // Authoring Tool (if software is purchased and includes authoring tools)
                 if (criteria.softwarePurchaseTypes.includes('authoringTools')) {
                     const isAuthoringToolChanged = changes && changes.authoringTool;
                     summary += `<li><strong>Software used to create electronic content:</strong> ${criteria.authoringTool === 'yes' ? 'Yes' : (criteria.authoringTool === 'no' ? 'No' : 'Not specified')} ${isAuthoringToolChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                 }
                
                // Hardware
                if (criteria.hardwareTypes.length > 0) {
                    const isChanged = changes && changes.hardwareTypes;
                    const hardwareLabels = {
                        'computers': 'Computers/Laptops',
                        'tablet': 'Tablets',
                        'printers': 'Printers, Scanners, or Copiers',
                        'multiFunction': 'Multi-function office machines',
                        'peripheral': 'Peripheral Equipment (i.e. keyboard, mouse)',
                        'kiosks': 'Information kiosks and transaction machines',
                        'mobile': 'Mobile phones',
                        'videoConf': 'Video Teleconference Equipment',
                        'videoDisplay': 'Video Displays or Monitors',
                        'servers': 'Servers',
                        'other': 'Other Hardware'
                    };
                    const hardwareList = criteria.hardwareTypes.map(type => hardwareLabels[type] || type).join(', ');
                    summary += `<li><strong>Hardware Purchased:</strong> ${hardwareList} ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                } else {
                    const isChanged = changes && changes.hardwareTypes;
                    summary += `<li><strong>Hardware Purchased:</strong> None of the above ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                }

                // Server Installation (if servers are purchased)
                if (criteria.hardwareTypes.includes('servers')) {
                     const isServerInstallationChanged = changes && changes.serverInstallation;
                     const serverInstallationLabel = {
                        'yes': 'Yes',
                        'no': 'No',
                        'dontKnow': 'I don\'t know'
                     };
                     summary += `<li><strong>Server requires physical installation or IaaS:</strong> ${serverInstallationLabel[criteria.serverInstallation] || 'Not specified'} ${isServerInstallationChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                 }
                
                // Support Services
                if (criteria.supportTypes.length > 0) {
                    const isChanged = changes && changes.supportTypes;
                    const supportLabels = {
                        'selfService': 'Automated self-service & Technical support',
                        'helpDesk': 'Help Desk or Call service center',
                        'productDoc': 'Product documentation',
                        'training': 'Training Service'
                    };
                    const supportList = criteria.supportTypes.map(type => supportLabels[type] || type).join(', ');
                    summary += `<li><strong>Support Documentation & Services:</strong> ${supportList} ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                } else {
                     const isChanged = changes && changes.supportTypes;
                     summary += `<li><strong>Support Documentation & Services:</strong> None of the above ${isChanged ? '<span style="color: #dc3545; font-weight: bold;">(CHANGED)</span>' : ''}</li>`;
                }
                
                summary += '</ul>';
                
                if (changes && Object.values(changes).some(changed => changed)) {
                    summary += '<p style="color: #dc3545; font-weight: bold; margin-bottom: 5px;"><em>Items marked as CHANGED reflect updates from your previous generation.</em></p>';
                }
                
                summary += '</div>';
                return summary;
            }

            // Function to compare criteria and detect changes
            function detectChanges(current, previous) {
                if (!previous) return null;
                
                const changes = {};
                changes.projectName = current.projectName !== previous.projectName;
                changes.solicitationPhase = current.solicitationPhase !== previous.solicitationPhase;
                changes.ictProducts = current.ictProducts !== previous.ictProducts;
                changes.ictServices = current.ictServices !== previous.ictServices;
                changes.exemption = current.exemption !== previous.exemption;

                // Econtent check needs to consider both radio and website URL
                changes.eContent = current.eContent !== previous.eContent || 
                                   current.webContent !== previous.webContent ||
                                   current.websiteURL !== previous.websiteURL;

                changes.softwareCriteria = JSON.stringify(current.softwareCriteria.sort()) !== JSON.stringify(previous.softwareCriteria.sort());
                changes.softwarePurchaseTypes = JSON.stringify(current.softwarePurchaseTypes.sort()) !== JSON.stringify(previous.softwarePurchaseTypes.sort());
                changes.cloudServiceType = JSON.stringify(current.cloudServiceType.sort()) !== JSON.stringify(previous.cloudServiceType.sort());
                changes.softwareWebBrowser = current.softwareWebBrowser !== previous.softwareWebBrowser;
                changes.authoringTool = current.authoringTool !== previous.authoringTool;
                changes.hardwareTypes = JSON.stringify(current.hardwareTypes.sort()) !== JSON.stringify(previous.hardwareTypes.sort());
                changes.serverInstallation = current.serverInstallation !== previous.serverInstallation;
                changes.supportTypes = JSON.stringify(current.supportTypes.sort()) !== JSON.stringify(previous.supportTypes.sort());
                
                return changes;
            }

            // Function to display output with edit capability
            function displayOutput(text) {
                const currentCriteria = getCurrentCriteria();
                const changes = detectChanges(currentCriteria, previousCriteria);
                const criteriaSummary = generateCriteriaSummary(currentCriteria, changes);
                
                // Get the selected solicitation phase for procurement officer guidance
                const solicitationPhase = document.querySelector('input[name="solicitationPhase"]:checked')?.value;
                
                let phaseGuidance = '';
                if (solicitationPhase === 'projectPlanning') {
                    phaseGuidance = `
                        <h4>Project Planning Phase Guidance</h4>
                        <p>Use these requirements to:</p>
                        <ul>
                            <li>Establish accessibility budget and timeline expectations</li>
                            <li>Identify required team expertise and roles</li>
                            <li>Plan for ongoing accessibility testing and validation</li>
                            <li>Understand compliance scope for your ICT procurement</li>
                        </ul>`;
                } else if (solicitationPhase === 'marketResearch') {
                    phaseGuidance = `
                        <h4>Market Research Phase Guidance</h4>
                        <p>Include these criteria in RFI/market research to:</p>
                        <ul>
                            <li>Evaluate vendor accessibility capabilities and experience</li>
                            <li>Request current Accessibility Conformance Reports (ACRs)</li>
                            <li>Assess marketplace availability of accessible solutions</li>
                            <li>Identify potential accessibility implementation challenges</li>
                        </ul>`;
                } else {
                    phaseGuidance = `
                        <h4>Solicitation Development Guidance</h4>
                        <p>Copy the requirements below into your Statement of Work (SOW), Performance Work Statement (PWS), or Statement of Objectives (SOO).</p>
                        <p><strong>Note:</strong> These requirements are designed to be vendor-agnostic and establish clear performance expectations. Customize based on your agency's specific needs.</p>`;
                }
                
                outputDiv.innerHTML = `
                    <h2>Generated Section 508 Requirements</h2>
                    ${criteriaSummary}
                    
                    <div class="procurement-guidance">
                        <h3>For Procurement Officers</h3>
                        
                        <h4>Why is this important?</h4>
                        <p>By including Section 508 requirements in the solicitation, you are ensuring potential Offerors know which Section 508 standards apply to commercially available technology products required to be offered by the vendor in their proposals, as well as requirements to ensure technology services provided will support the agency's ability to comply with the Section 508 law.</p>
                        
                        ${phaseGuidance}
                        
                        <h4>Procurement Process Requirements</h4>
                        <p>Procurement processes must:</p>
                        <ul>
                            <li>Integrate clear and measurable accessibility requirements directly into all solicitation documents, statements of work, and performance specifications</li>
                            <li>Require prospective vendors to thoroughly describe their organizational capabilities, policies, and processes for designing, developing, and delivering accessible ICT solutions, along with providing Accessibility Conformance Reports (ACRs) in OpenACR format (both HTML and YAML)</li>
                            <li>Vendors may be asked to provide video evidence that the ICT integrates seamlessly with diverse assistive technologies and does not create barriers for individuals with disabilities</li>
                            <li>Establish mechanisms for post-award verification of accessibility conformance and continuous monitoring of procured ICT throughout its lifecycle. Annual ACR submissions should be expected in projects with maintenance requirements</li>
                            <li>Document any exceptions or waivers to accessibility requirements, with clear justification, as per agency policy and federal regulations</li>
                        </ul>
                        
                        <h4>Government Oversight Responsibilities</h4>
                        <p>As the procurement officer, you must ensure ongoing compliance by:</p>
                        <ul>
                            <li>Regularly reviewing and validating ACR submissions for accuracy and completeness</li>
                            <li>Conducting periodic accessibility audits using both automated tools and expert evaluation</li>
                            <li>Monitoring contractor performance against accessibility milestones and deliverables</li>
                            <li>Ensuring timely remediation of identified accessibility issues</li>
                            <li>Documenting accessibility compliance status in all project reports and reviews</li>
                            <li>Escalating persistent accessibility non-compliance through appropriate contract management channels</li>
                        </ul>
                        
                        <p class="important-note">Important: Do not copy these instructions into the solicitation - only copy the requirements text below.</p>
                    </div>
                    
                    <label for="outputText">Review the requirements below. You can edit the text directly in the textarea.</label>
                    <textarea id="outputText" aria-describedby="output-instructions" style="width: 100%; height: 400px; padding: 10px; font-family: 'Courier New', monospace; font-size: 0.9em; border: 1px solid #ccc; border-radius: 5px; resize: vertical;">${text}</textarea>
                    <div id="output-instructions" style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Note:</strong> "Update Requirements from Form" will regenerate the requirements based on your current form selections above. Any manual edits to the text will be lost.
                    </div>
                    <div style="margin-top: 15px;">
                        <button type="button" id="copyToClipboard" style="margin-right: 10px;">Copy to Clipboard</button>
                        <button type="button" id="regenerateOutput" title="Re-run the form logic if you've changed any selections above">Update Requirements from Form</button>
                    </div>
                    <div id="copyStatus" style="margin-top: 10px; color: green; display: none;" role="status" aria-live="polite">Copied to clipboard!</div>
                `;
                
                // Store current criteria for next comparison
                previousCriteria = currentCriteria;

                // Add event listeners for the new buttons
                document.getElementById('copyToClipboard').addEventListener('click', function() {
                    const textArea = document.getElementById('outputText');
                    textArea.select();
                    document.execCommand('copy');
                    
                    const copyStatus = document.getElementById('copyStatus');
                    copyStatus.style.display = 'block';
                    setTimeout(() => {
                        copyStatus.style.display = 'none';
                    }, 2000);
                });

                document.getElementById('regenerateOutput').addEventListener('click', function() {
                    // Trigger form submission again to regenerate with current form values
                    form.dispatchEvent(new Event('submit'));
                });
            }

            // --- Initial calls for form setup ---
            
            // Step 1: Populate form from URL parameters (without triggering events)
            populateFormFromURL();
            
            // Step 2: Setup event handlers for "None of the above" logic AFTER population
            setupNoneHandling();
            
            // Step 3: Update conditional visibility based on current form state
            updateWebContentVisibility();
            updateSoftwareQuestionsVisibility();
            updateServerInstallationVisibility();

            // Do NOT auto-submit the form on page load - wait for user to click submit button
        });
    </script>
</body>
</html>
